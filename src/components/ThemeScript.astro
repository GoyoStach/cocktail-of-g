---
// Theme script component to be included in the head of all pages
export const prerender = true;
---

<script is:inline>
	// Immediately apply theme to prevent flash - runs before page renders
	(function () {
		// Check for saved theme preference, defaulting to 'light'
		let savedTheme;
		try {
			savedTheme = localStorage.getItem('theme');
		} catch {
			// localStorage might not be available (e.g., in SSR)
			savedTheme = null;
		}

		// Apply dark class immediately if needed
		if (savedTheme === 'dark') {
			document.documentElement.classList.add('dark');
		} else {
			document.documentElement.classList.remove('dark');
		}
	})();
</script>

<script>
	// Theme toggle functionality - runs after page loads
	function initTheme() {
		const themeToggle = document.getElementById('theme-toggle');
		const html = document.documentElement;

		if (!themeToggle) {
			// If button doesn't exist yet, try again in a moment
			setTimeout(initTheme, 100);
			return;
		}

		// Ensure correct initial state (double-check)
		let currentTheme;
		try {
			currentTheme = localStorage.getItem('theme') || 'light';
		} catch {
			currentTheme = 'light';
		}

		if (currentTheme === 'dark') {
			html.classList.add('dark');
		} else {
			html.classList.remove('dark');
		}

		// Remove any existing listeners to prevent duplicates
		themeToggle.removeEventListener('click', handleThemeToggle);

		// Add click event listener
		themeToggle.addEventListener('click', handleThemeToggle);
	}

	function handleThemeToggle() {
		const html = document.documentElement;
		html.classList.toggle('dark');

		// Save preference to localStorage
		const isDark = html.classList.contains('dark');
		try {
			localStorage.setItem('theme', isDark ? 'dark' : 'light');
		} catch (error) {
			console.warn('Could not save theme preference:', error);
		}
	}

	// Initialize theme functionality when DOM is loaded
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initTheme);
	} else {
		// DOM is already loaded
		initTheme();
	}

	// Also run when navigating between pages (for SPA-like behavior)
	document.addEventListener('astro:page-load', initTheme);

	// Run immediately as well (for edge cases)
	initTheme();
</script>
